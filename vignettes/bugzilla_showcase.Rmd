---
title: "Bugzilla Showcase"
output: 
  html_document:
    toc: true
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Bugzilla Showcase}
  %\VignetteEncoding{UTF-8}
---
# Introduction
This notebook explains how to fetch bugs from a Bugzilla website by downloading the issues and comments using Perceval and REST API. We will be using seven functions which can be found in the R folder.
  ~/kaiaulu/R/download.R: download_bugzilla, download_bugzilla_issues_from_rest_api, download_bugzilla_comments_from_rest_api
  ~/kaiaulu/R/parser.R: parse_bugzilla, parse_bugzillarest, parse_bugzilla_crawler_issue, parse_bugzilla_crawler_comments

Note: Perceval has two endpoints for Bugzilla, so we have two functions to parse Bugzilla data with different endpoints. One is the traditional backend, and the other one is the REST API backend for Bugzilla 5.0 (or higher) servers. The REST API backend will give us more information on the issue_creator and issue_assignee than the traditional backend. For more information, please check: https://github.com/chaoss/grimoirelab-perceval#bugzilla.

At the end of the showcase, we will have 
  json objects of Bugzilla data that is downloaded by Perceval from a Bugzilla website
  json files of Bugzilla data that is downloaded by REST API
  data tables with the parsed Bugzilla issues and comments

# Libraries

Please ensure the following R packages are installed on your computer. 

```{r warning = FALSE, message = FALSE}
rm(list = ls())
seed <- 1
set.seed(seed)

require(kaiaulu)
require(stringi)
require(data.table)
require(jsonlite)
```

# Project Configuration File (Parameters Needed)
The parameters necessary for analysis are kept in a project configuration file to ensure reproducibility. In this project, we will use Perceval, the path to which is kept in the `tools.yml` file, to download the Bugzilla data. 
```{r}
tools_path <- "../tools.yml"
tool <- yaml::read_yaml(tools_path)
perceval_path <- tool[["perceval"]]
```

# Bugzilla Wrapper
This section will talk about download and parse bugzilla data using Perceval traditional backend and REST API.
## Download Bugzilla data using Perceval's traditional Bugzilla Backend
We start by downloading the issues as json files using Perceval's traditional backend.

Meaning of the variables:
  date: the date/time to start bug retrieval
  bugzilla_site: URL to the Bugzilla site
  bugzilla_json: json object downloaded from the Bugzilla site

The bugzilla_json will be used to parse Bugzilla data and create a table of issues.

```{r}
date <- "2023-04-16T00:14:57Z"
bugzilla_site <- "https://bugzilla.redhat.com/"
bugzilla_json <- download_bugzilla(perceval_path, bugzilla_site, date, backend="bugzilla")
```

## Parse Bugzilla data obtained from Perceval's traditional Bugzilla backend
Next, we will parse the json object we downloaded from the previous step by using parse_bugzilla function.
First, let's try parsing just the issues without the comments.
```{r}
parse_bugzilla(bugzilla_json, comments=FALSE)
```

Next, let's see how the parsed table looks with the comments included.
```{r}
parse_bugzilla(bugzilla_json, comments=TRUE)
```

## Download Bugzilla issues and comments using Perceval's REST API Bugzilla Backend
Similar to downloading Bugzilla data using Perceval's traditional Bugzilla backend, we can also download the Bugzilla json object using Perceval's REST API Bugzilla backend.
```{r}
date <- "2023-04-16T00:14:57Z"
bugzilla_site <- "https://bugzilla.redhat.com/"
bugzilla_rest_json <- download_bugzilla(perceval_path, bugzilla_site, date, backend="bugzillarest")
```

## Parse Bugzilla data obtained from Perceval's REST API Bugzilla backend
We can use the 'parse_bugzillarest' function below to get a data table of Bugzilla issues without comments.
```{r}
parse_bugzillarest(bugzilla_rest_json, comments=FALSE)
```

If comments are of interest, we have the option to include these in our parsed Bugzilla data table.
```{r}
parse_bugzillarest(bugzilla_rest_json, comments=TRUE)
```
# Bugzilla crawler
This section will talk about download and parse bugzilla data using REST API.
## Download Bugzilla issues and comments from REST API
We start by downloading the issues and comments as json files using REST API.

Meaning of the variables:
  start_timestamp: the date/time to start bug retrieval
  bugzilla_site: URL to the Bugzilla site
  save_issues_path: json files about issues which downloaded from the Bugzilla site
  save_comments_path: json files about comments which downloaded from the Bugzilla site

The save_issues_path and save_comments_path will be used to parse Bugzilla data and create data tables.
```{r}
bugzilla_site <- "https://bugzilla.redhat.com/"
start_timestamp <- "2023-04-16T00:14:57Z"
save_issues_path <- "/home/mliu0141/hh/issues"
bug_ids <- download_bugzilla_issues_from_rest_api(bugzilla_site, start_timestamp, save_issues_path)

save_comments_path <- "/home/mliu0141/hh/comments"
download_bugzilla_comments_from_rest_api(bugzilla_site, bug_ids, save_comments_path)
```

## Parse Bugzilla issues data obtained from REST API
We can use the 'parse_bugzilla_crawler_issue' function below to get a data table of Bugzilla issues.
```{r}
parse_bugzilla_crawler_issue(save_issues_path)
```
## Parse Bugzilla comments data obtained from REST API
We can use the 'parse_bugzilla_crawler_comments' function below to get a data table of Bugzilla comments.
```{r}
parse_bugzilla_crawler_comments(save_comments_path)
```
